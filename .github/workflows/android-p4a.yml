name: Build Android APK with Kivy Docker

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build using Kivy Docker image
        run: |
          # Создаем простой main.py если его нет
          if [ ! -f main.py ]; then
            echo "print('Hello from Exam App')" > main.py
          fi

          # Запускаем сборку в Docker контейнере с предустановленными инструментами
          docker run --rm \
            -v $PWD:/src \
            -v $PWD/.buildozer:/home/user/.buildozer \
            kivy/kivy:latest \
            bash -c "
            cd /src &&
            apt-get update &&
            apt-get install -y build-essential zip unzip openjdk-8-jdk &&
            pip install buildozer &&
            buildozer init &&
            sed -i 's/^title = .*/title = Exam App/' buildozer.spec &&
            sed -i 's/^package.name = .*/package.name = examapp/' buildozer.spec &&
            sed -i 's/^package.domain = .*/package.domain = org.exam/' buildozer.spec &&
            sed -i 's/^orientation = .*/orientation = portrait/' buildozer.spec &&
            sed -i 's/^android.api = .*/android.api = 33/' buildozer.spec &&
            sed -i 's/^android.ndk = .*/android.ndk = 25b/' buildozer.spec &&
            sed -i 's/^android.permissions = .*/android.permissions = INTERNET/' buildozer.spec &&
            buildozer android debug
            "

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-apk
          path: bin/*.apk